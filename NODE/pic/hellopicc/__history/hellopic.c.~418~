
#INCLUDE <16F887.H>
#DEVICE ADC=10
#INCLUDE <STRING.H>
#INCLUDE <STDLIB.H>
#INCLUDE <STDIO.H>
#INCLUDE <MATH.H>
//#INCLUDE <TV_LCD.C>
/*
int atoi(CONST char *s) : sting --> sô nguyên
long atol(CONST char *s) : string --> sô nguyên dài
float atof(CONST char *s) : string --> sô thuc
*/
#FUSES NOWDT, PUT, HS
#USE DELAY(CLOCK=20M)
#USE RS232(BAUD=9600,XMIT=PIN_C6,RCV=PIN_C7)
#define BT1_PIN PIN_B1
#define BT2_PIN PIN_B2
#define BT3_PIN PIN_B3
#define LCD_ENABLE_PIN  PIN_E0                                   
#define LCD_RS_PIN      PIN_E1                                
#define LCD_RW_PIN      PIN_E2                              
#define LCD_DATA4       PIN_C0                               
#define LCD_DATA5       PIN_C1                                 
#define LCD_DATA6       PIN_C2                                   
#define LCD_DATA7       PIN_C3  
#INCLUDE <LCD.C>
UNSIGNED INT16 KQADC,AN0, AN1;
UNSIGNED INT8 CONFIG_FUN, CONFIG_TT, CONFIG_NODE=0;


INT8 id = 1,DATA1 = 2;
CHAR *NHAN1[], *NHAN[]="HELLO";
CHAR *PACKAGE[]={"S","ID", "COMMAND" ,"LENGHT","DATA1", "DATA2","CHECKSUM","#"};
CHAR NHIETDO1[]="27";
CHAR NHIETDO2[]="27";
char id_[]="0";
CHAR RCV[]="RECEIVED";
UNSIGNED INT8 KYTU[30], VT=0,TTNHAN=0;   

//--------------------------------------------------------------------//
#INT_RDA
VOID NGAT()
{
   KYTU[VT] = GETC ();
   IF (KYTU[VT] == id_[0])
   {
      TTNHAN = 1;
   }

   IF (KYTU[VT] == '.')
   {
      
      KYTU[VT] = '\0';
      VT = 0;
      TTNHAN = 1;
   }

   ELSE
   VT++;
}
VOID CHON_ID(){
          id ++;
          IF (id > 15) id = 0;
          delay_ms (300);
          ITOA (id, 10, id_);          
          LCD_GOTOXY (1, 2) ;
          DELAY_MS (10);
          PRINTF (LCD_PUTC, id_);
          DELAY_MS (1);
          OUTPUT_TOGGLE (PIN_D0);
          PACKAGE[1] = id_;
}
VOID BUTT_OK(){
   
}


VOID quet_phim()
{
   IF (input (BT1_PIN) == 0) //neu nut bam duoc bam
   {
      LCD_GOTOXY (1, 1) ;
      DELAY_MS (10);
      PRINTF (LCD_PUTC, "BT1");

      FOR (INT I=0; I<10; I++){
         IF(input (BT1_PIN) == 0){
            DELAY_MS(1000);
            IF(I==9){
               //CONFIG NODE
               CONFIG_NODE=1;
            }
         }
         ELSE{
            BUTT_OK();
         }       
      }      
   }

   else IF (input (BT2_PIN) == 0) //neu nut bam duoc bam
   {
      LCD_GOTOXY (1, 1) ;
      DELAY_MS (10);
      PRINTF (LCD_PUTC, "BT2");
      BUTT_FUN();
   }

   else IF (input (BT3_PIN) == 0) //neu nut bam duoc bam
   {
      LCD_GOTOXY (1, 1) ;
      DELAY_MS (10);
      PRINTF (LCD_PUTC, "BT3");
      BUTT_TT();
   }
}

#INT_EXT
 VOID ngat_ngoai ()
 {
    quet_phim () ;
 }

 VOID XUATLCD()
 {
    LCD_GOTOXY (1, 1) ;
    DELAY_MS (10);
    PRINTF (LCD_PUTC, KYTU);
    DELAY_MS (1);
 }

 INT ADC_READ(INT kenh)
 {
    SET_ADC_CHANNEL (kenh);
    KQADC = 0;
    FOR (INT I = 0; I < 100; I++)
    {
       KQADC = KQADC + READ_ADC () ;
       DELAY_MS (1);
    }

    KQADC = KQADC / (100 * 2.046);
    RETURN KQADC;
 }

 VOID chuong_trinh_con ()
 {
    for (INT i = 0; i<= 30; i++)
    {
        OUTPUT_TOGGLE (PIN_D1);
       delay_ms (100);
    }
 }

 VOID MAIN()
 {
    SET_TRIS_D (0XF0);
    SET_TRIS_B (0xFF);
    SET_TRIS_E (0);
    SET_TRIS_C (0x80);
    #USE RS232 (BAUD = 9600, XMIT = PIN_C6, RCV = PIN_C7)
    SETUP_ADC (ADC_CLOCK_DIV_8);
    SETUP_ADC_PORTS (sAN0);
    // OUTPUT_D (0X00);
    ENABLE_INTERRUPTS (INT_RDA);
    ENABLE_INTERRUPTS (GLOBAL);
    ENABLE_INTERRUPTS (INT_TIMER0);
    enable_interrupts (INT_EXT); //Cho phep ngat ngoai
    enable_interrupts (INT_EXT_H2L); //Ngat xay ra khi co xung tu cao xuong thap
    //enable_interrupts (GLOBAL); //Cho phep ngat
    LCD_INIT (); // KHOI TAO LCD
    NHAN = "HI";
    id = 0;
    LCD_GOTOXY (1, 1) ;
    DELAY_MS (10);
    PRINTF (LCD_PUTC, NHAN);
    DELAY_MS(2000);
    WHILE (TRUE)
    {
       //AN1 = ADC_READ (1) ;
       AN0 = ADC_READ (0) ;
       chuong_trinh_con ();
       IF (AN0 > 26)
       {
          ITOA (AN0, 10, NHIETDO1);
          PACKAGE[4] = NHIETDO1;
          ITOA (AN1, 10, NHIETDO2);
          PACKAGE[5] = NHIETDO2;
          
          for (INT i = 0; i < 8; i++)
          {
             PRINTF (PACKAGE[i]);
             DELAY_MS (1);
          }

          
          DELAY_MS (1000);
       }

       IF (TTNHAN == 1)
       {
          
          TTNHAN = 0;
          XUATLCD ();
          
          OUTPUT_TOGGLE (PIN_D0);
          OUTPUT_TOGGLE (PIN_D1);
          OUTPUT_TOGGLE (PIN_D2);
          OUTPUT_TOGGLE (PIN_D3);
       }
    }
 }

 

